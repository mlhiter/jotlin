# 实时评论功能测试文档

## 功能实现概览

### 1. 轮询机制 ✅

- 实现了 `useRealtimeComments` Hook
- 每5秒自动检查新评论
- 支持页面可见性检测（页面隐藏时停止轮询）
- 支持手动触发检查

### 2. 增量更新 API ✅

- 修改了 `/api/comments` GET 端点
- 支持 `incrementalUpdate=true` 和 `since` 参数
- 只返回指定时间后的新评论
- 返回格式包含 `lastUpdateTime` 用于下次查询

### 3. 用户体验优化 ✅

- 避免覆盖现有评论的加载状态
- 新评论平滑添加，带有高亮效果
- 实时状态指示器显示轮询状态
- Toast 通知告知新评论

## 测试场景

### 场景1：同一文档多用户协作

1. 用户A和用户B同时打开同一文档
2. 用户A添加评论
3. 5秒内用户B应该能看到新评论（带蓝色高亮）
4. 3秒后高亮效果消失

### 场景2：AI评论自动获取

1. 用户在评论中@AI
2. AI处理后自动创建回复评论
3. 轮询机制应该获取到AI的回复评论

### 场景3：页面可见性处理

1. 用户打开文档后切换到其他标签页
2. 轮询应该停止（节省资源）
3. 切换回来时轮询恢复

## 关键技术实现

### useRealtimeComments Hook

```typescript
// 特点：
- 轮询间隔：5秒
- 页面可见性检测
- 防重复获取
- 手动触发机制
```

### 增量更新逻辑

```typescript
// API参数：
?documentId=xxx&incrementalUpdate=true&since=2024-01-01T00:00:00.000Z

// 返回格式：
{
  comments: [...],
  lastUpdateTime: "2024-01-01T00:05:00.000Z",
  isIncremental: true
}
```

### 新评论高亮

```css
/* 新评论样式 */
.bg-blue-50.border-l-4.border-l-blue-500.animate-in.slide-in-from-right-5
```

## 测试步骤

1. 启动开发服务器
2. 创建或打开一个文档
3. 在两个不同浏览器窗口打开同一文档
4. 在一个窗口添加评论
5. 观察另一个窗口是否在5秒内显示新评论
6. 验证新评论是否有蓝色高亮效果
7. 验证3秒后高亮效果是否消失

## 预期结果

- ✅ 协作者能在5秒内看到新评论
- ✅ 新评论以增量方式添加，不覆盖现有评论
- ✅ 没有烦人的全局加载状态
- ✅ 新评论有视觉高亮提示
- ✅ 实时状态指示器工作正常
